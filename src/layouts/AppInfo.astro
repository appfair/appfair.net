---
import Layout from './Layout.astro';
import { apps, type AppInfo } from "@/lib/apps";
import { getLangFromUrl, useTranslations, localDate, formatSize } from '@/lib/i18n';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

export async function getStaticPaths() {
    // the keys of the Record<string, AppInfo> are the app tokens
    return Object.keys(apps).map(tok => ({ params: { token: tok } }));
}

const { token } = Astro.params;
if (!token) {
    throw new Error(`No token parameter`);
}

const tok: string = token;
const app: AppInfo = apps[tok];
//console.log(`app: ${app}`);

if (!app) {
  throw new Error(`App with token "${token}" not found`);
}

const tokenLower = token.toLowerCase();

//console.log(`app.ios: ${app.ios}`);

const iosInfo = app.ios?.appInfo;
// console.log(`iosInfo: ${iosInfo}`);

//const fdroidInfo = app.fdroid?.appInfo; // TODO

const appStoreLink = app.ios?.appleItemId ? `https://apps.apple.com/app/${tokenLower}/id${app.ios?.appleItemId}` : null;
const playStoreLink = app.android?.appid ? `https://play.google.com/store/apps/details?id=${app.android?.appid}` : null;

const appName = iosInfo?.name ?? app.token;
const appSubtitle = iosInfo?.subtitle ?? "";
const appDescription = iosInfo?.localizedDescription ?? "";
const appIcon = iosInfo?.iconURL ?? "";

const sourceCodeURL = `https://github.com/${token}/${token}`;
const privacyPolicyURL = "https://appfair.org/privacy";
---
<Layout title={appName}>
  <main class="app-detail">
    <div class="app-container">
      <!-- Header -->
      <div class="app-header">
        <div class="app-header-content">
          <div class="app-icon-large">
            <img src={appIcon} alt={`${appName} icon`} />
          </div>
          <div class="app-header-info force-wrap">
            <h1>{appName}</h1>
            <p class="subtitle">{appSubtitle}</p>
            <!-- <div class="developer">{app.developer}</div> -->
          </div>
        </div>

        <div class="app-stats-bar">
          <div class="stat">
            <div class="stat-value">{localDate(app.ios?.appInfo?.versions[0]?.date, lang, 'medium')}</div>
            <div class="stat-label">{t('app.releasedate')}</div>
          </div>
          <div class="stat-divider"></div>
          <div class="stat">
            <div class="stat-value">{app.ios?.appInfo?.versions[0]?.version} ({app.ios?.appInfo?.versions[0]?.buildVersion})</div>
            <div class="stat-label">{t('app.version')}</div>
          </div>
          <div class="stat-divider"></div>
          <div class="stat">
              <div class="stat-value">{formatSize(app.ios?.appInfo?.versions[0]?.size, lang)}</div>
              <div class="stat-label">{t('app.size')}</div>
            </div>
          </div>

          <!-- <div class="stat">
            <div class="stat-value">{app.rating}</div>
            <div class="stat-label">{app.reviews} Ratings</div>
          </div>
          <div class="stat-divider"></div>
          <div class="stat">
            <div class="stat-value">{app.age}</div>
            <div class="stat-label">Age</div>
          </div>
          <div class="stat-divider"></div>
          <div class="stat">
            <div class="stat-value">{app.size}</div>
            <div class="stat-label">Size</div>
          </div> -->
        </div>

        <div class="download-section">
            {appStoreLink && (
            <a href={appStoreLink} class="btn-download btn-ios"><img src="https://appfair.org/assets/badges/apple-app-store.svg" alt="Download on the Apple App Store"/></a>
            )}
            {playStoreLink && (
              <a href={playStoreLink} class="btn-download btn-android"><img src="https://appfair.org/assets/badges/google-play-store.svg" alt="Download on the Google Play Store"/></a>
            )}
        </div>
      </div>

      <!-- Screenshots -->
      <section class="screenshots-section">
        <h2>{t('app.screenshots')}</h2>
        <div class="screenshots-scroll">
          {iosInfo?.screenshots?.iphone?.map((screenshot, index) => (
            <div class="screenshot-item">
              <img src={screenshot} alt={`Screenshot ${index + 1}`} />
            </div>
          ))}
        </div>
      </section>

      <!-- Description -->
      <section class="description-section">
        <h2>{t('app.about')}</h2>
        <pre>{appDescription}</pre>
      </section>

      <!-- Permissions -->
      <section class="permissions-section force-wrap">
        <h2>{t('app.permissions')}</h2>
        <div class="permissions-grid">
          {iosInfo?.appPermissions?.privacy?.map((permission) => (
            <div class="permission-card">
              <div class="permission-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <path d="M12 6v6l4 2"></path>
                </svg>
              </div>
              <div class="permission-content">
                <h3>{permission.name}</h3>
                <p>{permission.usageDescription}</p>
              </div>
            </div>
          )) || <p>None</p>}
        </div>
        <h2>{t('app.entitlements')}</h2>
        <div class="permissions-grid">
          {iosInfo?.appPermissions?.entitlements?.map((entitlement) => (
            <div class="permission-card">
              <div class="permission-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <path d="M12 6v6l4 2"></path>
                </svg>
              </div>
              <div class="permission-content">
                <h3>{entitlement.name}</h3>
              </div>
            </div>
          )) || <p>None</p>}
        </div>
      </section>

      <!-- Links -->
      <section class="links-section force-wrap">
        <h2>{t('app.devres')}</h2>
        <div class="links-grid">
            <a href={sourceCodeURL} class="link-card" target="_blank" rel="noopener">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="16 18 22 12 16 6"></polyline>
                <polyline points="8 6 2 12 8 18"></polyline>
              </svg>
              <div>
                <h3>{t('app.devres.source')}</h3>
                <p>View on GitHub</p>
              </div>
            </a>
            <a href={privacyPolicyURL} class="link-card" target="_blank" rel="noopener">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
              </svg>
              <div>
                <h3>{t('app.privacy')}</h3>
                <p>{t('app.privacy.learn')}</p>
              </div>
            </a>
        </div>
      </section>
    </div>
  </main>
</Layout>